
$(function() {
    // Initialise datepickers for absence form
    initDatePickers()

    initCalendar()
});


/*
 * Creates a datepicker UI when user clicks on date input box in the absence form.
 * Automatically ranges, UK date format and no weekends can be selected.
 * TODO: Could clean this up. Think DRY.
 */
function initDatePickers() {
    $( "#absence_date_from" ).datepicker({
        dateFormat: 'dd/mm/yy',
        changeMonth: true,
        changeYear: true,
        beforeShowDay: $.datepicker.noWeekends,
        onClose: function( selectedDate ) {
            $( "#absence_date_to" ).datepicker( "option", "minDate", selectedDate );
        }
    });
    $( "#absence_date_to" ).datepicker({
        dateFormat: 'dd/mm/yy',
        changeMonth: true,
        changeYear: true,
        beforeShowDay: $.datepicker.noWeekends,
        onClose: function( selectedDate ) {
            $( "#absence_date_from" ).datepicker( "option", "maxDate", selectedDate );
        }
    });
}

function initCalendar() {
    $('#calendar').fullCalendar({
        header: {
            left: 'prev,next today',
            center: 'title',
            right: false
        },
        //eventClick: function(calEvent, jsEvent, view) {
        //    if (calEvent.type === 'bank-holiday') return false;
        //    window.location = "/vacations/" + calEvent.id
        //},
        theme: true,
        events: "/calendar",
        disableDragging: true,
        weekends: false
    });


    $('.fc-button-next, .fc-button-prev, .fc-button-today').bind('click', monthNavigation);

    function monthNavigation(e) {
        var currentDate = $('#calendar').fullCalendar('getDate')
                , currentMonth = currentDate.getMonth()
                , currentYear = currentDate.getFullYear()
                , urlString = '/calendar/show?year=' + currentYear + '&month=' + currentMonth

        e.preventDefault();
        history.pushState('', '', urlString);
        $('#calendar').fullCalendar('gotoDate', currentYear, currentMonth);
    }

    var monthParam = getParameterByName('month')
            , yearParam = getParameterByName('year')
            , monthAndYearParam = monthParam && yearParam;

    if (monthAndYearParam) {
        $('#calendar').fullCalendar('gotoDate', yearParam, monthParam);
    }
}